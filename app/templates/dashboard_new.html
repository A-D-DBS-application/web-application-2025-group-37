{% extends 'base.html' %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-gray-900">{{ t('Dashboard') }}</h1>
    <div class="text-sm text-gray-500">{{ t('Laatste update') }}: <span class="font-semibold">{{ t('Nu') }}</span></div>
  </div>

  <!-- ===== 5 MAIN KPI CARDS ===== -->
  <div class="dashboard-metrics-grid-5 mb-8">
    
    <!-- Card 1: Totale Fietsen -->
    <div class="dashboard-metric-card glow-green">
      <div class="metric-icon-circle bg-gradient-green">
        <span class="text-3xl">ğŸš²</span>
      </div>
      <div class="metric-content">
        <div class="metric-main-value">{{ total_bikes }}</div>
        <div class="metric-main-label">{{ t('Totale fietsen') }}</div>
        <div class="metric-sub-stats">
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Beschikbaar') }}</span>
            <span class="metric-sub-value text-green-600">{{ available_bikes_count }}</span>
          </div>
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Verhuurd') }}</span>
            <span class="metric-sub-value text-blue-600">{{ rented_bikes_count }}</span>
          </div>
          {% if repair_bikes_count > 0 %}
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Reparatie') }}</span>
            <span class="metric-sub-value text-orange-600">{{ repair_bikes_count }}</span>
          </div>
          {% endif %}
          {% if missing_bikes_count > 0 %}
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Vermist') }}</span>
            <span class="metric-sub-value text-red-600">{{ missing_bikes_count }}</span>
          </div>
          {% endif %}
        </div>
        <div class="metric-trend positive">
          â†‘ {{ t('Vandaag') }} +{{ new_bikes_today }} {{ t('nieuwe ingeleverd') }}
        </div>
        <div class="metric-progress-bar mt-3">
          <div class="metric-progress-fill bg-gradient-green" style="width: {{ bike_availability_percentage }}%"></div>
        </div>
        <div class="metric-progress-label">{{ bike_availability_percentage }}% {{ t('beschikbaar') }}</div>
      </div>
    </div>

    <!-- Card 2: Actieve Leden -->
    <div class="dashboard-metric-card glow-blue">
      <div class="metric-icon-circle bg-gradient-blue">
        <span class="text-3xl">ğŸ‘¥</span>
      </div>
      <div class="metric-content">
        <div class="metric-main-value">{{ active_members_count }}</div>
        <div class="metric-main-label">{{ t('Actieve leden') }}</div>
        <div class="metric-sub-stats">
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Totaal') }}</span>
            <span class="metric-sub-value">{{ total_members }}</span>
          </div>
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Deze maand') }}</span>
            <span class="metric-sub-value text-green-600">+{{ new_members_this_month }}</span>
          </div>
          {% if overdue_members_count > 0 %}
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Achterstallig') }}</span>
            <span class="metric-sub-value text-red-600">{{ overdue_members_count }}</span>
          </div>
          {% endif %}
        </div>
        <div class="metric-progress-bar mt-3">
          <div class="metric-progress-fill bg-gradient-blue" style="width: {{ active_member_percentage }}%"></div>
        </div>
        <div class="metric-progress-label">{{ active_member_percentage }}% {{ t('actief') }}</div>
      </div>
    </div>

    <!-- Card 3: Kinderen (NEW) -->
    <div class="dashboard-metric-card glow-pink">
      <div class="metric-icon-circle bg-gradient-pink">
        <span class="text-3xl">ğŸ‘¶</span>
      </div>
      <div class="metric-content">
        <div class="metric-main-value">{{ total_children }}</div>
        <div class="metric-main-label">{{ t('Kinderen') }}</div>
        <div class="metric-sub-stats">
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Met fiets') }}</span>
            <span class="metric-sub-value text-green-600">{{ total_children - children_without_bike }}</span>
          </div>
          {% if children_without_bike > 0 %}
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Zonder fiets') }}</span>
            <span class="metric-sub-value text-orange-600">{{ children_without_bike }}</span>
          </div>
          {% endif %}
        </div>
        {% if new_children_this_month > 0 %}
        <div class="metric-trend positive">
          â†‘ {{ t('Deze maand') }} +{{ new_children_this_month }}
        </div>
        {% endif %}
        <div class="metric-progress-bar mt-3">
          <div class="metric-progress-fill bg-gradient-pink" style="width: {{ children_with_bike_percentage }}%"></div>
        </div>
        <div class="metric-progress-label">{{ children_with_bike_percentage }}% {{ t('met fiets') }}</div>
      </div>
    </div>

    <!-- Card 4: Betalingen -->
    <div class="dashboard-metric-card glow-purple">
      <div class="metric-icon-circle bg-gradient-purple">
        <span class="text-3xl">ğŸ’³</span>
      </div>
      <div class="metric-content">
        <div class="metric-main-value">â‚¬{{ "%.0f"|format(payments_this_month) }}</div>
        <div class="metric-main-label">{{ t('Ontvangen deze maand') }}</div>
        <div class="metric-sub-stats">
          {% if overdue_amount > 0 %}
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Openstaand') }}</span>
            <span class="metric-sub-value text-red-600">â‚¬{{ "%.0f"|format(overdue_amount) }}</span>
          </div>
          {% endif %}
        </div>
        {% if overdue_members_count > 0 %}
        <div class="metric-trend negative">
          âš ï¸ {{ overdue_members_count }} {{ t('achterstallige betalingen') }}
        </div>
        {% else %}
        <div class="metric-trend positive">
          âœ“ {{ t('Alle betalingen up-to-date') }}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Card 5: Actieve Verhuringen (NEW) -->
    <div class="dashboard-metric-card glow-orange">
      <div class="metric-icon-circle bg-gradient-orange">
        <span class="text-3xl">ğŸ“‹</span>
      </div>
      <div class="metric-content">
        <div class="metric-main-value">{{ active_rentals_count }}</div>
        <div class="metric-main-label">{{ t('Actieve verhuringen') }}</div>
        <div class="metric-sub-stats">
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Vandaag uit') }}</span>
            <span class="metric-sub-value text-green-600">{{ rentals_today }}</span>
          </div>
          <div class="metric-sub-item">
            <span class="metric-sub-label">{{ t('Vandaag terug') }}</span>
            <span class="metric-sub-value text-blue-600">{{ returns_today }}</span>
          </div>
        </div>
        {% if rentals_due_tomorrow > 0 %}
        <div class="metric-trend neutral">
          â° {{ rentals_due_tomorrow }} {{ t('morgen verwacht') }}
        </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- ===== QUICK ACTIONS BAR ===== -->
  <div class="quick-actions-bar mb-8">
    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
      <span>âš¡</span> {{ t('Snelle acties') }}
    </h2>
    <div class="quick-actions-grid">
      <a href="{{ url_for('main.bikes_new') }}" class="quick-action-btn bg-gradient-green">
        <span class="text-2xl">ğŸš²</span>
        <span class="quick-action-label">{{ t('Nieuwe fiets') }}</span>
      </a>
      <a href="{{ url_for('main.members_new') }}" class="quick-action-btn bg-gradient-blue">
        <span class="text-2xl">ğŸ‘¤</span>
        <span class="quick-action-label">{{ t('Nieuw lid') }}</span>
      </a>
      <a href="{{ url_for('main.members_list') }}" class="quick-action-btn bg-gradient-purple">
        <span class="text-2xl">ğŸ’³</span>
        <span class="quick-action-label">{{ t('Betaling registreren') }}</span>
      </a>
      <a href="{{ url_for('main.inventory') }}" class="quick-action-btn bg-gradient-orange">
        <span class="text-2xl">ğŸ“¦</span>
        <span class="quick-action-label">{{ t('Inventaris') }}</span>
      </a>
    </div>
  </div>

  <!-- ===== TO-DO LIST ===== -->
  {% if todo_items %}
  <div class="dashboard-chart-card mb-8">
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
      <span>ğŸ“Œ</span> {{ t('Te doen') }}
    </h2>
    <div class="space-y-2">
      {% for item in todo_items[:10] %}
      <div class="todo-item priority-{{ item.priority }}">
        <div class="todo-icon">
          {% if item.type == 'payment' %}ğŸ’³
          {% elif item.type == 'rental' %}ğŸš²
          {% elif item.type == 'repair' %}ğŸ”§
          {% elif item.type == 'child' %}ğŸ‘¶
          {% endif %}
        </div>
        <div class="todo-content">
          <div class="todo-title">{{ item.title }}</div>
          <div class="todo-message">{{ item.message }}</div>
        </div>
        <div class="todo-priority-badge badge-{{ item.priority }}">
          {{ t(item.priority) }}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ===== CHARTS GRID (4 charts) ===== -->
  <div class="charts-grid-4 mb-8">
    
    <!-- Chart 1: Verhuuractiviteit (Line chart) -->
    <div class="dashboard-chart-card">
      <h3 class="chart-title">{{ t('Verhuuractiviteit (laatste 7 dagen)') }}</h3>
      <canvas id="rentalActivityChart"></canvas>
    </div>

    <!-- Chart 2: Ledenverdeling (Pie chart) -->
    <div class="dashboard-chart-card">
      <h3 class="chart-title">{{ t('Ledenverdeling') }}</h3>
      <canvas id="memberPieChart"></canvas>
    </div>

    <!-- Chart 3: Inventaris per categorie (Bar chart) -->
    <div class="dashboard-chart-card">
      <h3 class="chart-title">{{ t('Inventaris per categorie') }}</h3>
      <canvas id="inventoryBarChart"></canvas>
    </div>

    <!-- Chart 4: Betalingen (laatste 6 maanden) (Line chart) -->
    <div class="dashboard-chart-card">
      <h3 class="chart-title">{{ t('Betalingen trend') }}</h3>
      <canvas id="paymentTrendChart"></canvas>
    </div>

  </div>

  <!-- ===== INSIGHTS GRID ===== -->
  <div class="insights-grid-3 mb-8">
    
    <!-- Insight 1: Populaire modellen -->
    <div class="insight-card">
      <h3 class="insight-title">ğŸ† {{ t('Populairste fietsen') }}</h3>
      <div class="insight-list">
        {% for model in popular_models[:5] %}
        <div class="insight-item">
          <div class="insight-item-name">{{ model.name }}</div>
          <div class="insight-item-value">{{ model.count }} {{ t('verhuringen') }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Insight 2: Reparatie overzicht -->
    <div class="insight-card">
      <h3 class="insight-title">ğŸ”§ {{ t('Reparatie status') }}</h3>
      <div class="insight-stats">
        <div class="insight-stat-item">
          <div class="insight-stat-label">{{ t('In reparatie') }}</div>
          <div class="insight-stat-value">{{ repair_stats.total_in_repair }}</div>
        </div>
        <div class="insight-stat-item">
          <div class="insight-stat-label">{{ t('Gem. duur') }}</div>
          <div class="insight-stat-value">{{ repair_stats.avg_repair_time }} {{ t('dagen') }}</div>
        </div>
      </div>
      {% if repair_stats.bikes %}
      <div class="insight-list mt-3">
        {% for bike in repair_stats.bikes[:3] %}
        <div class="insight-item-small">{{ bike.name }}</div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Insight 3: Wanbetalers -->
    <div class="insight-card">
      <h3 class="insight-title">âš ï¸ {{ t('Wanbetalers') }}</h3>
      {% if top_debtors %}
      <div class="insight-list">
        {% for debtor in top_debtors[:5] %}
        <div class="insight-item">
          <div class="insight-item-name">{{ debtor.first_name }} {{ debtor.last_name }}</div>
          <div class="insight-item-value text-red-600">
            {% if debtor.last_payment %}
            {{ ((now - debtor.last_payment).days) }} {{ t('dagen') }}
            {% else %}
            {{ t('Nooit betaald') }}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-6 text-green-600 font-semibold">
        âœ… {{ t('Alle leden up-to-date!') }}
      </div>
      {% endif %}
    </div>

  </div>

  <!-- ===== RENTAL HEATMAP ===== -->
  <div class="dashboard-chart-card mb-8">
    <h3 class="chart-title">ğŸ”¥ {{ t('Verhuur heatmap (per uur)') }}</h3>
    <div class="heatmap-container">
      {% for hour in range(24) %}
      <div class="heatmap-cell" data-value="{{ rental_hours[hour] }}" 
           style="background-color: rgba(59, 130, 246, {{ (rental_hours[hour] / (rental_hours|max if rental_hours|max > 0 else 1)) }});">
        <div class="heatmap-hour">{{ "%02d"|format(hour) }}:00</div>
        <div class="heatmap-value">{{ rental_hours[hour] }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== STATISTICS BAR ===== -->
  <div class="stats-bar mb-8">
    <div class="stat-item">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-content">
        <div class="stat-label">{{ t('Gemiddelde verhuurduur') }}</div>
        <div class="stat-value">{{ "%.1f"|format(avg_rental_duration) }} {{ t('dagen') }}</div>
      </div>
    </div>
    {% if unused_bikes %}
    <div class="stat-item">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-content">
        <div class="stat-label">{{ t('Fietsen 30+ dagen niet verhuurd') }}</div>
        <div class="stat-value">{{ unused_bikes|length }}</div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ===== ACHIEVEMENTS ===== -->
  {% if achievements %}
  <div class="achievements-bar mb-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ† {{ t('Prestaties') }}</h3>
    <div class="achievements-grid">
      {% for achievement in achievements %}
      <div class="achievement-badge">
        <span class="achievement-icon">{{ achievement.icon }}</span>
        <span class="achievement-text">{{ achievement.text }}</span>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ===== BIKE CATEGORIES ===== -->
  <div class="bike-categories-section mb-8">
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
      <span>ğŸ“¦</span> {{ t('Objectvoorraad per categorie') }}
    </h2>
    <h3 class="text-md font-semibold text-gray-700 mb-3">{{ t('Fietsvoorraad') }}</h3>
    <div class="category-grid">
      {% for category in bike_categories %}
      <div class="category-card">
        <div class="category-header">
          <span class="category-icon">ğŸš²</span>
          <span class="category-name">{{ category.name }}</span>
        </div>
        <div class="category-stats">
          <div class="category-stat">
            <span class="category-stat-label">{{ t('Totaal') }}</span>
            <span class="category-stat-value">{{ category.total }}</span>
          </div>
          <div class="category-stat">
            <span class="category-stat-label">{{ t('Beschikbaar') }}</span>
            <span class="category-stat-value text-green-600">{{ category.available }}</span>
          </div>
          <div class="category-stat">
            <span class="category-stat-label">{{ t('Verhuurd') }}</span>
            <span class="category-stat-value text-blue-600">{{ category.rented }}</span>
          </div>
        </div>
        <div class="category-progress">
          <div class="category-progress-bar">
            <div class="category-progress-fill bg-blue-500" style="width: {{ (category.rented / category.total * 100) if category.total > 0 else 0 }}%"></div>
          </div>
          <div class="category-progress-label">{{ ((category.rented / category.total * 100) if category.total > 0 else 0)|round(0) }}% {{ t('verhuurd') }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== RECENT ACTIVITY ===== -->
  <div class="recent-activity-section">
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
      <span>ğŸ“‹</span> {{ t('Recente activiteit') }}
    </h2>
    <div class="activity-list">
      {% for activity in recent_activity[:15] %}
      <div class="activity-item">
        <div class="activity-icon activity-icon-{{ activity.type }}">
          {% if activity.type == 'rental' %}ğŸš²
          {% elif activity.type == 'return' %}âœ…
          {% elif activity.type == 'member' %}ğŸ‘¤
          {% elif activity.type == 'payment' %}ğŸ’³
          {% endif %}
        </div>
        <div class="activity-content">
          <div class="activity-title">{{ activity.title }}</div>
          <div class="activity-subtitle">{{ activity.subtitle }}</div>
        </div>
        <div class="activity-time">{{ activity.time }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>

<!-- ===== CHART.JS INITIALIZATION ===== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Chart 1: Rental Activity (Line)
  const rentalCtx = document.getElementById('rentalActivityChart');
  if (rentalCtx) {
    new Chart(rentalCtx, {
      type: 'line',
      data: {
        labels: {{ rental_chart_labels | tojson }},
        datasets: [
          {
            label: '{{ t("Verhuringen") }}',
            data: {{ rental_chart_rentals | tojson }},
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true
          },
          {
            label: '{{ t("Terugbrengingen") }}',
            data: {{ rental_chart_returns | tojson }},
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }

  // Chart 2: Member Pie
  const memberPieCtx = document.getElementById('memberPieChart');
  if (memberPieCtx) {
    new Chart(memberPieCtx, {
      type: 'doughnut',
      data: {
        labels: {{ member_pie_labels | tojson }},
        datasets: [{
          data: {{ member_pie_values | tojson }},
          backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#3b82f6']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // Chart 3: Inventory Bar Chart
  const inventoryCtx = document.getElementById('inventoryBarChart');
  if (inventoryCtx) {
    new Chart(inventoryCtx, {
      type: 'bar',
      data: {
        labels: {{ inventory_chart_labels | tojson }},
        datasets: [
          {
            label: '{{ t("Beschikbaar") }}',
            data: {{ inventory_chart_available | tojson }},
            backgroundColor: 'rgba(34, 197, 94, 0.7)'
          },
          {
            label: '{{ t("Verhuurd") }}',
            data: {{ inventory_chart_rented | tojson }},
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        },
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }

  // Chart 4: Payment Trend (Line)
  const paymentCtx = document.getElementById('paymentTrendChart');
  if (paymentCtx) {
    new Chart(paymentCtx, {
      type: 'line',
      data: {
        labels: {{ payment_months | tojson }},
        datasets: [{
          label: '{{ t("Betalingen") }} (â‚¬)',
          data: {{ payment_amounts | tojson }},
          borderColor: 'rgb(168, 85, 247)',
          backgroundColor: 'rgba(168, 85, 247, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

});
</script>

{% endblock %}
