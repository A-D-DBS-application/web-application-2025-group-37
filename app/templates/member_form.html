{% extends "base.html" %}
{% block content %}
<h2 class="section-title text-2xl md:text-3xl font-semibold mb-4">{{ 'Nieuw lid' if mode == 'new' else 'Lid bewerken' }}</h2>

<form method="POST" class="card p-6 space-y-4">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block mb-1 font-medium">Voornaam</label>
      <input name="first_name" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.first_name if member else '' }}" required>
    </div>
    <div>
      <label class="block mb-1 font-medium">Achternaam</label>
      <input name="last_name" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.last_name if member else '' }}" required>
    </div>
    <div>
      <label class="block mb-1 font-medium">Email</label>
      <input name="email" type="email" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.email if member else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Telefoonnummer</label>
      <input name="phone" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.phone if member else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Straat</label>
      <input name="street" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.street if member else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Nr</label>
      <input name="house_number" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.house_number if member else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Postcode</label>
      <input name="postcode" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.postcode if member else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Stad</label>
      <input name="city" type="text" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.city if member else '' }}">
    </div>
    {% if mode != 'new' %}
    <div>
      <label class="block mb-1 font-medium">Laatste betaling</label>
      <input name="last_payment" type="date" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ member.last_payment.strftime('%Y-%m-%d') if member and member.last_payment else '' }}">
    </div>
    <div>
      <label class="block mb-1 font-medium">Status</label>
      <select name="status" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
        {% set st = (member.status if member else (member_statuses[0] if member_statuses else '')) %}
        {% for s in member_statuses %}
          <option value="{{ s }}" {{ 'selected' if st==s else '' }}>{{ s=='active' and 'actief' or s=='inactive' and 'inactief' or s }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>

  <div class="pt-4 border-t">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Kinderen</h3>
    </div>
  <div id="children-list" class="space-y-3">
      {% if member and member.children %}
        {% for c in member.children %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
          <input name="child_first_name[]" placeholder="Voornaam" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ c.first_name }}">
          <div class="flex gap-2">
            <input name="child_last_name[]" placeholder="Achternaam" class="flex-1 border rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" value="{{ c.last_name }}">
            <button type="button" class="btn remove-child">Verwijderen</button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
          <input name="child_first_name[]" placeholder="Voornaam" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
          <div class="flex gap-2">
            <input name="child_last_name[]" placeholder="Achternaam" class="flex-1 border rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
            <button type="button" class="btn remove-child">Verwijderen</button>
          </div>
        </div>
      {% endif %}
    </div>
    <div class="mt-3">
      <button type="button" id="add-child" class="btn btn-primary">Kind toevoegen</button>
    </div>
  </div>

  <div class="flex items-center gap-3 pt-2">
    <button class="btn btn-primary tooltip" aria-label="{{ t('Aanmaken') if mode == 'new' else t('Opslaan') }}" title="{{ t('Aanmaken') if mode == 'new' else t('Opslaan') }}" data-tooltip="{{ t('Aanmaken') if mode == 'new' else t('Opslaan') }}">
      <span class="sr-only">{{ t('Aanmaken') if mode == 'new' else t('Opslaan') }}</span>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <path d="M17 21V13H7v8"/>
        <path d="M7 3v5h8"/>
      </svg>
    </button>
    <a class="btn" href="{{ url_for('main.members_list') }}">{{ t('Annuleren') }}</a>
  </div>
</form>

<script>
  document.getElementById('add-child').addEventListener('click', function() {
    const list = document.getElementById('children-list');
    const row = document.createElement('div');
    row.className = 'grid grid-cols-1 md:grid-cols-2 gap-3 items-center';
    row.innerHTML = `
      <input name="child_first_name[]" placeholder="Voornaam" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
      <div class="flex gap-2">
        <input name="child_last_name[]" placeholder="Achternaam" class="flex-1 border rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
        <button type="button" class="btn remove-child">Verwijderen</button>
      </div>
    `;
    // Insert directly after the first child row if it exists, else append
    const firstRow = list.querySelector('.grid');
    if (firstRow && firstRow.nextSibling) {
      list.insertBefore(row, firstRow.nextSibling);
    } else if (firstRow) {
      list.appendChild(row);
    } else {
      list.appendChild(row);
    }
  });

  // Enable remove child for dynamically added and existing rows
  document.getElementById('children-list').addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('remove-child')) {
      const row = e.target.closest('.grid');
      if (row) row.remove();
    }
  });
</script>
{% endblock %}
