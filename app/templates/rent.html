{% extends "base.html" %}
{% block content %}
<h2 class="section-title text-2xl md:text-3xl font-semibold mb-4">Fiets verhuren</h2>
<div class="card p-6 max-w-xl mx-auto">
  <div class="mb-4">
    <h3 class="text-xl font-bold">{{ bike.name }}</h3>
    <p class="text-gray-600">Type: {{ bike.type or '-' }}</p>
  </div>
  <form method="POST" class="space-y-4">
    <div>
      <label class="block mb-1 font-medium">Lid</label>
      <select name="member_id" id="member-select" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" required>
        <option value="">Kies lid...</option>
        {% for m in members %}
          <option value="{{ m.member_id }}" data-children='[{% for c in m.children %}{"id":"{{ c.child_id }}","name":"{{ c.first_name }} {{ c.last_name }}"}{% if not loop.last %},{% endif %}{% endfor %}]'>
            {{ m.last_name }}, {{ m.first_name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block mb-1 font-medium">Kind</label>
      <select name="child_id" id="child-select" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200">
        <option value="">Geen kind</option>
      </select>
      <div id="child-warning" class="hidden mt-2 text-sm rounded-md p-2 border border-yellow-200 bg-yellow-50 text-yellow-800"></div>
    </div>
    <div>
      <label class="block mb-1 font-medium">Startdatum</label>
      <input type="date" name="start_date" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" required />
    </div>
    <div class="text-sm text-gray-600">
      Einddatum wordt automatisch een jaar na startdatum.
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Betaalmethode</label>
        <select name="payment_method" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" required>
          <option value="">Kies methode...</option>
          <option value="cash">Contant</option>
          <option value="card">Kaart</option>
          <option value="bank_transfer">Overschrijving</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-medium">Bedrag (â‚¬)</label>
        <input type="number" name="amount" step="0.01" min="0" class="border w-full rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-200" required />
        <p class="text-xs text-gray-500 mt-1">Voor bankoverschrijving vink je ontvangst aan zodra bevestigd.</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input type="checkbox" id="received" name="received" value="true" class="rounded">
      <label for="received" class="text-sm text-gray-700">Ontvangen (alleen relevant voor overschrijving)</label>
    </div>
    <div class="flex items-center gap-3">
      <button class="btn btn-primary">Verhuren</button>
      <a class="btn" href="{{ url_for('main.inventory') }}">{{ t('Annuleren') }}</a>
    </div>
  </form>
</div>

<script>
  const memberSelect = document.getElementById('member-select');
  const childSelect = document.getElementById('child-select');
    const childWarning = document.getElementById('child-warning');
    const submitBtn = document.querySelector('button.btn.btn-primary');
  memberSelect.addEventListener('change', function() {
    const opt = this.options[this.selectedIndex];
    const data = opt.getAttribute('data-children');
    let children = [];
    try { children = JSON.parse(data || '[]'); } catch(e) { children = []; }
    childSelect.innerHTML = '<option value="">Geen kind</option>';
    for (const c of children) {
      const o = document.createElement('option');
      o.value = c.id; o.textContent = c.name;
      childSelect.appendChild(o);
    }
      // reset warning
      childWarning.classList.add('hidden');
      childWarning.textContent='';
      if (submitBtn) submitBtn.disabled = false;
  });

    childSelect.addEventListener('change', async function() {
      const cid = this.value;
      childWarning.classList.add('hidden');
      childWarning.textContent='';
      if (submitBtn) submitBtn.disabled = false;
      if (!cid) return;
      try {
        const res = await fetch(`/api/child/${cid}/has-active-rental`);
        const data = await res.json();
        if (data.hasActiveRental) {
          const msg = data.bikeName ? `Dit kind heeft al een actieve verhuring (fiets: ${data.bikeName}).` : 'Dit kind heeft al een actieve verhuring.';
          childWarning.textContent = msg;
          childWarning.classList.remove('hidden');
          if (submitBtn) submitBtn.disabled = true;
        }
      } catch(e) {
        // ignore
      }
    });
</script>
{% endblock %}
